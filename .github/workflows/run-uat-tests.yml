name: Run UAT Tests after Deploy

on:
 repository_dispatch:
   types: [post-deploy-uat-tests]

jobs:
 run-tests:
   runs-on: ubuntu-latest

   steps:
     - name: Install jq and yq
       run: |
         sudo apt-get update && sudo apt-get install -y jq
         sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
         sudo chmod +x /usr/bin/yq  

     - name: Fetch Updated Service name and Version 
       run: |
         git clone https://x-access-token:${{ secrets.TOKEN_GITHUB }}@github.com/punnam14/recommendation-engine-infra-repo.git infra-repo
         cd infra-repo

         SERVICE=$(jq -r '.service' kubernetes/argocd/meta/last-service-updated.json)
         VERSION=$(jq -r '.version' kubernetes/argocd/meta/last-service-updated.json)
         echo "SERVICE=$SERVICE" >> $GITHUB_ENV
         echo "VERSION=$VERSION" >> $GITHUB_ENV
     
     - name: Send UAT Completion Notification
       uses: dawidd6/action-send-mail@v3
       env:
         SERVICE: ${{ env.SERVICE }}
         VERSION: ${{ env.VERSION }}
       with:
         server_address: smtp.ethereal.email
         server_port: 587
         username: ${{ secrets.ETHEREAL_USER }}
         password: ${{ secrets.ETHEREAL_PASS }}
         subject: "‚úÖ UAT Passed - Ready for Prod"
         body: |
           Service **$SERVICE** has been upgraded to version **$VERSION** and successfully deployed to the UAT environment.
           
           üîç You can test it at: [UAT Link](https://uat.hottake.pro/)

           üëâ Once verified, please proceed with production deployment by manually running the following workflow prod-promotion.yml at link:
           [Run Production Promotion Workflow](https://github.com/punnam14/recommendation-engine-infra-repo/actions)
         to: your-team@yourcompany.com
         from: "UAT Bot <uat-bot@ethereal.email>"


    